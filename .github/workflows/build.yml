name: Truth AI Build - Emergency Fix

on:
  workflow_dispatch: {}

env:
  FLUTTER_VERSION: '3.19.0'

jobs:
  regenerate-android:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Backup project files
      run: |
        mkdir -p backup
        cp -r lib backup/ || true
        cp pubspec.yaml backup/ || true
        cp -r assets backup/ || true  # Si vous avez un dossier assets

    - name: Regenerate Android project
      run: |
        echo "Regenerating Android project..."
        rm -rf android
        flutter create --androidx -a kotlin --project-name truth_ai_verifier .

    - name: Restore project files
      run: |
        cp -r backup/lib/* lib/ || true
        cp backup/pubspec.yaml . || true
        cp -r backup/assets/* assets/ || true
        rm -rf backup

    - name: Verify Android structure
      run: |
        echo "=== ANDROID STRUCTURE VERIFICATION ==="
        find android/ -name "AndroidManifest.xml"
        echo "=== MAIN ANDROIDMANIFEST ==="
        cat android/app/src/main/AndroidManifest.xml

    - name: Test build
      run: |
        echo "Testing Android build..."
        flutter build apk --debug || echo "Build test completed"

    - name: Upload regenerated Android project
      uses: actions/upload-artifact@v4
      with:
        name: regenerated-android-project
        path: android/
        retention-days: 1
