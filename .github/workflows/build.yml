name: Build Truth AI APK

on:
  push:
    branches: [main, master, development]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      build-type:
        description: 'Type de build'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

env:
  FLUTTER_VERSION: '3.22.0'
  JAVA_VERSION: '17'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    # -----------------------------------------------------
    # 1ï¸âƒ£  RÃ©cupÃ©ration du code
    # -----------------------------------------------------
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -----------------------------------------------------
    # 2ï¸âƒ£  DÃ©tection du projet Flutter
    # -----------------------------------------------------
    - name: ğŸ” Detect Flutter Project
      id: detect-project
      run: |
        echo "ğŸ” Scanning for Flutter project..."
        if [ -f "pubspec.yaml" ]; then
          echo "ğŸ“ Project found at root"
          echo "project_dir=." >> $GITHUB_OUTPUT
        elif [ -f "truthsound_app/pubspec.yaml" ]; then
          echo "ğŸ“ Project found in truthsound_app"
          echo "project_dir=truthsound_app" >> $GITHUB_OUTPUT
        else
          PROJECT_DIR=$(find . -name 'pubspec.yaml' -type f -maxdepth 3 | head -1 | xargs dirname 2>/dev/null || echo ".")
          echo "ğŸ“ Auto-detected project: $PROJECT_DIR"
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ“‹ Project structure:"
        find . -name 'pubspec.yaml' -type f | head -5

    - name: ğŸ“Š Debug Info
      run: |
        echo "ğŸ—ï¸ Build Type: ${{ github.event.inputs.build-type || 'release' }}"
        echo "ğŸ“ Project Directory: ${{ steps.detect-project.outputs.project_dir }}"
        echo "ğŸ¦ Flutter Version: ${{ env.FLUTTER_VERSION }}"
        echo "â˜• Java Version: ${{ env.JAVA_VERSION }}"
        echo ""
        echo "ğŸ“¦ Project Content:"
        ls -la ${{ steps.detect-project.outputs.project_dir }}

    # -----------------------------------------------------
    # 3ï¸âƒ£  Configuration des environnements
    # -----------------------------------------------------
    - name: âš™ï¸ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools-version: "33.0.2"
        ndk-version: "25.1.8937393"
        cmake-version: "3.22.1"

    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}

    # -----------------------------------------------------
    # 4ï¸âƒ£  Gestion du cache & dÃ©pendances
    # -----------------------------------------------------
    - name: â™»ï¸ Cache Pub Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: ${{ runner.os }}-pub-

    - name: ğŸ§¹ Clean & Install Dependencies
      run: |
        flutter clean
        flutter pub get --verbose
      working-directory: ${{ steps.detect-project.outputs.project_dir }}

    # -----------------------------------------------------
    # 5ï¸âƒ£  Analyse et tests
    # -----------------------------------------------------
    - name: ğŸ©º Flutter Doctor
      run: flutter doctor -v

    - name: ğŸ” Analyze Code
      run: flutter analyze
      working-directory: ${{ steps.detect-project.outputs.project_dir }}

    - name: ğŸ§ª Run Tests
      run: flutter test || echo "âš ï¸ No tests found"
      working-directory: ${{ steps.detect-project.outputs.project_dir }}

    # -----------------------------------------------------
    # 6ï¸âƒ£  (Optionnel) Signature du build release
    # -----------------------------------------------------
    - name: ğŸ” Setup Keystore
      if: ${{ github.event.inputs.build-type == 'release' }}
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > android/app/release.keystore
        echo "storeFile=release.keystore" >> android/key.properties
        echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
        echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
        echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
      working-directory: ${{ steps.detect-project.outputs.project_dir }}

    # -----------------------------------------------------
    # 7ï¸âƒ£  Build APK
    # -----------------------------------------------------
    - name: ğŸ—ï¸ Build APK
      id: build-apk
      run: |
        if [ "${{ github.event.inputs.build-type || 'release' }}" = "debug" ]; then
          echo "ğŸ”¨ Building Debug APK..."
          flutter build apk --debug --verbose
          echo "apk_path=${{ steps.detect-project.outputs.project_dir }}/build/app/outputs/flutter-apk/app-debug.apk" >> $GITHUB_OUTPUT
          echo "build_type=debug" >> $GITHUB_OUTPUT
        else
          echo "ğŸ”¨ Building Release APK..."
          flutter build apk --release --split-per-abi --verbose
          echo "apk_path=${{ steps.detect-project.outputs.project_dir }}/build/app/outputs/flutter-apk/app-release.apk" >> $GITHUB_OUTPUT
          echo "build_type=release" >> $GITHUB_OUTPUT
        fi
      working-directory: ${{ steps.detect-project.outputs.project_dir }}

    - name: ğŸ“‹ List Build Outputs
      run: |
        echo "ğŸ“ Build outputs:"
        find ${{ steps.detect-project.outputs.project_dir }}/build -name "*.apk" -type f | head -10
        echo ""
        echo "ğŸ“Š APK Info:"
        ls -lh ${{ steps.build-apk.outputs.apk_path }}

    # -----------------------------------------------------
    # 8ï¸âƒ£  Upload APK
    # -----------------------------------------------------
    - name: ğŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: truth-ai-${{ steps.build-apk.outputs.build_type }}-apk
        path: ${{ steps.build-apk.outputs.apk_path }}
        retention-days: 30
        if-no-files-found: warn

    # -----------------------------------------------------
    # 9ï¸âƒ£  RÃ©sumÃ© du build
    # -----------------------------------------------------
    - name: ğŸ“ Build Summary
      if: always()
      run: |
        echo "## ğŸ—ï¸ Build Result" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Build Type** | ${{ steps.build-apk.outputs.build_type }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Project Dir** | ${{ steps.detect-project.outputs.project_dir }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Flutter Version** | ${{ env.FLUTTER_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "### âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "APK generated: \`${{ steps.build-apk.outputs.apk_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the APK from the Artifacts section." >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs for details." >> $GITHUB_STEP_SUMMARY
        fi

  # -----------------------------------------------------
  # ğŸ”’ Job 2 : Security Scan
  # -----------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-android
    
    steps:
    - name: ğŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        name: truth-ai-release-apk
        path: ./apks

    - name: ğŸ”’ Basic Security Check
      run: |
        echo "ğŸ” Basic APK Security Check"
        if [ -f "./apks/app-release.apk" ]; then
          echo "ğŸ“± APK File Info:"
          file ./apks/app-release.apk
          echo ""
          echo "ğŸ“Š APK Size:"
          ls -lh ./apks/app-release.apk
        else
          echo "âŒ APK not found for security scan"
        fi

  # -----------------------------------------------------
  # ğŸ“¢ Job 3 : Notification finale
  # -----------------------------------------------------
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [build-android, security-scan]
    if: always()
    
    steps:
    - name: ğŸ“¢ Build Status
      run: |
        echo "ğŸ—ï¸ Build completed with status: ${{ needs.build-android.result }}"
        echo "ğŸ”’ Security scan: ${{ needs.security-scan.result }}"
