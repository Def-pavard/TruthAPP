name: Truth AI Build - Emergency Fix

on:
  workflow_dispatch: {}

env:
  FLUTTER_VERSION: '3.19.0'

jobs:
  regenerate-android:
    runs-on: ubuntu-latest
    timeout-minutes: 14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Skip Android licenses
      run: |
        echo "=== SKIPPING ANDROID LICENSES ==="
        echo "Licenses will be accepted during the actual build if needed"

    - name: Create Android structure manually
      run: |
        rm -rf android 2>/dev/null || true
        mkdir -p android/app/src/main/kotlin/com/truthai/verifier
        mkdir -p android/app/src/main/res
        mkdir -p android/app/src/debug
        mkdir -p android/app/src/profile
        mkdir -p android/gradle/wrapper
        echo "Basic Android directory structure created"

    - name: Create AndroidManifest.xml (no heredoc)
      run: |
        printf '%s\n' \
        '<manifest xmlns:android="http://schemas.android.com/apk/res/android">' \
        '    <uses-permission android:name="android.permission.INTERNET"/>' \
        '    <application' \
        '        android:name="io.flutter.app.FlutterApplication"' \
        '        android:label="Truth AI Verifier"' \
        '        android:icon="@mipmap/ic_launcher"' \
        '        android:usesCleartextTraffic="true">' \
        '        <activity' \
        '            android:name=".MainActivity"' \
        '            android:exported="true"' \
        '            android:launchMode="singleTop"' \
        '            android:theme="@style/LaunchTheme"' \
        '            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"' \
        '            android:hardwareAccelerated="true"' \
        '            android:windowSoftInputMode="adjustResize">' \
        '            <meta-data' \
        '                android:name="io.flutter.embedding.android.NormalTheme"' \
        '                android:resource="@style/NormalTheme" />' \
        '            <intent-filter>' \
        '                <action android:name="android.intent.action.MAIN"/>' \
        '                <category android:name="android.intent.category.LAUNCHER"/>' \
        '            </intent-filter>' \
        '        </activity>' \
        '        <meta-data android:name="flutterEmbedding" android:value="2" />' \
        '    </application>' \
        '</manifest>' \
        > android/app/src/main/AndroidManifest.xml
        echo "AndroidManifest.xml written"

    - name: Create android/app/build.gradle (fixed escaping)
      run: |
        printf '%s\n' \
        "def kotlin_version = '1.7.10'" \
        "def flutterRoot = System.getenv('FLUTTER_ROOT')" \
        "apply plugin: 'com.android.application'" \
        "apply plugin: 'kotlin-android'" \
        "apply from: \"\\\$flutterRoot/packages/flutter_tools/gradle/flutter.gradle\"" \
        "" \
        "android {" \
        "    namespace \"com.truthai.verifier\"" \
        "    compileSdkVersion 34" \
        "" \
        "    defaultConfig {" \
        "        applicationId \"com.truthai.verifier\"" \
        "        minSdkVersion 21" \
        "        targetSdkVersion 34" \
        "        versionCode 1" \
        "        versionName \"1.0.0\"" \
        "    }" \
        "" \
        "    buildTypes {" \
        "        debug { signingConfig signingConfigs.debug }" \
        "        release {" \
        "            signingConfig signingConfigs.debug" \
        "            minifyEnabled true" \
        "            shrinkResources true" \
        "            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'" \
        "        }" \
        "    }" \
        "}" \
        "" \
        "flutter { source '../..' }" \
        "" \
        "dependencies {" \
        "    implementation \"org.jetbrains.kotlin:kotlin-stdlib-jdk7:\\\$kotlin_version\"" \
        "}" \
        > android/app/build.gradle
        echo "android/app/build.gradle written"

    - name: Create android/build.gradle (fixed escaping)
      run: |
        printf '%s\n' \
        "buildscript {" \
        "    ext.kotlin_version = '1.7.10'" \
        "    repositories { google(); mavenCentral() }" \
        "    dependencies {" \
        "        classpath 'com.android.tools.build:gradle:7.3.0'" \
        "        classpath \"org.jetbrains.kotlin:kotlin-gradle-plugin:\\\$kotlin_version\"" \
        "    }" \
        "}" \
        "" \
        "def flutterRoot = System.getenv('FLUTTER_ROOT')" \
        "" \
        "allprojects { repositories { google(); mavenCentral() } }" \
        "" \
        "rootProject.buildDir = '../build'" \
        "subprojects { project.buildDir = \"\\\${rootProject.buildDir}/\\\${project.name}\" }" \
        "subprojects { project.evaluationDependsOn(':app') }" \
        "" \
        "task clean(type: Delete) { delete rootProject.buildDir }" \
        > android/build.gradle
        echo "android/build.gradle written"

    - name: Create gradle.properties, wrapper, proguard, MainActivity (no heredoc)
      run: |
        printf '%s\n' 'org.gradle.jvmargs=-Xmx1536M' 'android.useAndroidX=true' 'android.enableJetifier=true' > android/gradle.properties
        printf '%s\n' 'distributionBase=GRADLE_USER_HOME' 'distributionPath=wrapper/dists' 'zipStoreBase=GRADLE_USER_HOME' 'zipStorePath=wrapper/dists' 'distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-all.zip' > android/gradle/wrapper/gradle-wrapper.properties
        printf '%s\n' '// Proguard rules for Truth AI' > android/app/proguard-rules.pro
        printf '%s\n' 'package com.truthai.verifier' '' 'import io.flutter.embedding.android.FlutterActivity' '' 'class MainActivity: FlutterActivity() {}' > android/app/src/main/kotlin/com/truthai/verifier/MainActivity.kt
        echo "Other small files written"

    - name: Verify Android structure
      run: |
        [ -d "android" ] && echo "Android dir ✅" || (echo "Android dir ❌" && exit 1)
        [ -f "android/app/src/main/AndroidManifest.xml" ] && echo "Manifest ✅" || (echo "Manifest ❌" && exit 1)
        [ -f "android/app/src/main/kotlin/com/truthai/verifier/MainActivity.kt" ] && echo "MainActivity ✅" || (echo "MainActivity ❌" && exit 1)

    - name: Optional: flutter pub get (fast)
      run: |
        echo "Running flutter pub get (optional)"
        flutter pub get || echo "flutter pub get failed or had warnings"

    - name: Upload regenerated Android project
      uses: actions/upload-artifact@v4
      with:
        name: regenerated-android-project
        path: android/
        retention-days: 1
